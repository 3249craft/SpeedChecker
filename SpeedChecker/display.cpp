#include "display.h"
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

const char FIRMWARE_VERSION[] = "SpeedChkr v0.0.1b";

static Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

static const uint8_t logo_v1[] PROGMEM = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x9F, 0x98,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xFF, 0xFC,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xFF, 0xFC,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xF0, 0xF8,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x78,
    0x07, 0xF0, 0x0F, 0xF0, 0x7F, 0xC0, 0x1E, 0x0F, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x00, 0x38,
    0x1F, 0xFC, 0x1F, 0xF8, 0x7F, 0xE0, 0x1E, 0x1F, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x7C, 0x70, 0x1E,
    0x3C, 0x1E, 0x1C, 0x3C, 0xF0, 0xE0, 0x3E, 0x3C, 0x38, 0x00, 0x00, 0x00, 0x00, 0x70, 0x70, 0x1F,
    0x30, 0x07, 0x18, 0x1C, 0xE0, 0x60, 0x7E, 0x38, 0x18, 0x00, 0x00, 0x00, 0x00, 0x60, 0x70, 0x1F,
    0x71, 0xD3, 0x00, 0x1C, 0x00, 0x60, 0xF6, 0x38, 0x1C, 0x3F, 0x0F, 0xC7, 0xF1, 0xFD, 0xFE, 0x1F,
    0x67, 0xF3, 0x00, 0x1C, 0x00, 0xE1, 0xE6, 0x38, 0x18, 0x7F, 0x1F, 0xC7, 0xF9, 0xFD, 0xFE, 0x3C,
    0xE6, 0x73, 0x81, 0xF8, 0x01, 0xE1, 0xC6, 0x38, 0x1C, 0xE0, 0x1C, 0x00, 0x38, 0xE0, 0x70, 0x78,
    0xEE, 0x33, 0x83, 0xF8, 0x1F, 0xC3, 0x86, 0x1F, 0xFC, 0xE0, 0x18, 0x00, 0x38, 0x60, 0x70, 0xF8,
    0xCE, 0x33, 0x81, 0xFC, 0x7F, 0x87, 0x06, 0x1F, 0xFC, 0xE0, 0x18, 0x07, 0xF8, 0x60, 0x70, 0xFC,
    0xE6, 0x3B, 0x00, 0x1C, 0xF8, 0x07, 0x0F, 0x07, 0xDC, 0xE0, 0x18, 0x0F, 0xF8, 0x60, 0x70, 0xFC,
    0x67, 0xFF, 0x00, 0x1C, 0xE0, 0x07, 0xFF, 0x80, 0x1C, 0xE0, 0x18, 0x1C, 0x38, 0x60, 0x70, 0x98,
    0x63, 0xDE, 0x00, 0x1C, 0xE0, 0x07, 0xFF, 0x80, 0x1C, 0xE0, 0x18, 0x1C, 0x38, 0x60, 0x70, 0x00,
    0x30, 0x00, 0x18, 0x1C, 0xE0, 0x00, 0x06, 0x18, 0x38, 0xE0, 0x18, 0x1C, 0x38, 0x60, 0x70, 0x00,
    0x3C, 0x00, 0x1F, 0xFC, 0xFF, 0xE0, 0x06, 0x1F, 0xF8, 0xFF, 0x18, 0x1F, 0xF8, 0x60, 0x7E, 0x00,
    0x1F, 0xF8, 0x1F, 0xF8, 0xFF, 0xE0, 0x06, 0x1F, 0xF8, 0x7F, 0x18, 0x0F, 0xF8, 0x60, 0x3E, 0x00,
    0x07, 0xF0, 0x03, 0xC0, 0x00, 0x00, 0x00, 0x07, 0xE0, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

bool display_init() {
    if (!display.begin(SSD1306_SWITCHCAPVCC, OLED_ADDR)) {
        return false;
    }
    display.clearDisplay();
    return true;
}

void display_show_splash() {
    unsigned long start = millis();
    uint16_t progress = 0;
    uint8_t prng = (uint8_t)(start | 1);

    while (progress < SCREEN_WIDTH) {
        unsigned long elapsed = millis() - start;
        uint16_t target = (uint32_t)elapsed * SCREEN_WIDTH / SPLASH_DURATION_MS;
        prng ^= prng << 3;
        prng ^= prng >> 5;
        prng ^= prng << 1;
        int8_t jitter = (int8_t)(prng % 5) - 2;
        int16_t next_progress = (int16_t)target + jitter;
        if (next_progress < (int16_t)progress) {
            next_progress = progress;
        }
        if (next_progress > SCREEN_WIDTH) {
            next_progress = SCREEN_WIDTH;
        }
        progress = (uint16_t)next_progress;

        display.clearDisplay();
        display.drawBitmap(0, 14, logo_v1, SCREEN_WIDTH, 32, SSD1306_WHITE);
        display.setTextSize(1);
        display.setTextColor(SSD1306_WHITE);
        display.setCursor(0, 0);
        display.print(FIRMWARE_VERSION);
        display.fillRect(0, SCREEN_HEIGHT - 3, progress, 3, SSD1306_WHITE);
        display.display();

        prng ^= prng << 2;
        prng ^= prng >> 7;
        prng ^= prng << 3;
        uint8_t delay_ms = 30 + (prng % 120);
        delay(delay_ms);
    }
}

void display_draw_speed(const SpeedData& data) {
    char buf[8];
    char min_buf[12];
    char pps_buf[16];

    display.clearDisplay();
    display.setTextColor(SSD1306_WHITE);

    display.setTextSize(1);
    display.setCursor(0, 0);
    dtostrf(data.current_speed_kmh, 4, 1, buf);
    display.print(buf);
    display.print("km/h");
    display.setTextSize(1);
    display.setCursor(96, 0);
    display.print(data.signal_active ? "SIG" : "NO");

    display.setTextSize(1);
    display.setCursor(0, 20);
    snprintf(pps_buf, sizeof(pps_buf), "PPS %lu", data.pulses_per_second);
    display.print(pps_buf);
    display.print(" MIN ");
    snprintf(min_buf, sizeof(min_buf), "%luus", data.min_interval_us);
    display.print(min_buf);

    display.display();
}

void display_clear() {
    display.clearDisplay();
    display.display();
}
